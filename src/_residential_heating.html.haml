:coffeescript
  sectors = [34, 35]
  possible_levels = [4, 4]
  trajectory = []
  
  # This takes an array of possible levels and returns
  # all its possible combinations.
  # e.g., combinations([4]) => [[1],[2],[3],[4]]
  # e.g., combinations([4,2]) => [[1,1], [1,2], [2,1], ... [4,1], [4,2]]
  combinations = (possible_levels, i = 0) ->
    if i >= (possible_levels.length-1)
      ([j] for j in [1..possible_levels[i]])
    else
      sub_combinations = combinations(possible_levels, i+1)
      combinations_at_this_level = []
      for level in [1..possible_levels[i]]
        for combination in sub_combinations
          c = combination.slice()
          c.unshift(level)
          combinations_at_this_level.push(c)
      combinations_at_this_level

  # This returns a trajectory class for a particular trajectory
  trajectoryClass = (t) ->
    ".trajectory"+t.join('')

  highlight = (highlight_trajectory) ->
    () ->
      # Set the code
      for s, i in sectors
        window.code[s] = highlight_trajectory[i]

      # Update the CSS
      $(".trajectory").removeClass("highlight")
      $(trajectoryClass(highlight_trajectory)).addClass("highlight")

      # Notify that the implications need updating
      window.updateImplication()

  unHighlight = (highlight_trajectory) ->
    () ->
      # Set the code
      for s, i in sectors
        window.code[s] = trajectory[i]

      # Update the CSS
      $(trajectoryClass(highlight_trajectory)).removeClass("highlight")

      # Notify that the implications need updating
      window.updateImplication()

  chooseTrajectory = (new_trajectory) ->
    () ->
      # Set the code
      trajectory = new_trajectory
      for s, i in sectors
        window.code[s] = trajectory[i]

      # Update the CSS
      $(".trajectory").removeClass("highlight")
      $(".trajectory").removeClass("chosen")
      $(trajectoryClass(trajectory)).addClass("chosen")

      # Notify that the implication needs updating
      window.updateImplication()
      # Notify that the pathway has changed, so the URL changes
      window.notifyPathwayChanged()

  window.setupQuestion = () ->
    # Figure out the current trajectory for the sectorss we care about
    for s, i in sectors
      trajectory[i] = window.code[s]
    
    # Make sure we display the correct trajectory onscreen
    chooseTrajectory(trajectory)()

    # Now setup all the controls
    for possible_trajectory in combinations(possible_levels)
      $(trajectoryClass(possible_trajectory))
          .hover( highlight(possible_trajectory), unHighlight(possible_trajectory) )
          .click( chooseTrajectory(possible_trajectory) )
  
%h1 How should homes be heated?

%p In 2007, 82% of homes were heated with gas boilers. It is expected that the 26 million heating systems in existing homes and the systems in 14 million new homes will need to be replaced by 2050. The 2050 calculator considers eleven technologies that could be used to replace existing heaters.

%table
  %tr
    %th
    %th Gas or biogas boiler
    %th Coal or biomass boiler
    %th Resistive electric heater
    %th Air-source heat pump
    %th Ground-source heat pump
    %th In home stirling engine micro-CHP
    %th In home fuel-cell micro-CHP
    %th Gas or biogas CHP connected through local district heating network
    %th Coal or biomass CHP connected through a district heating network
    %th Geothermal heat connected through a local district heating network
    %th District heating network connected to a large power station
  %tr.trajectory.trajectory11
    %td Mainly gas or biogas boilers
    %td 90%
    %td
    %td 10%
    %td
    %td
    %td
    %td
    %td
    %td
    %td
    %td
  %tr.trajectory.trajectory12
    %td District heating, mainly powered by coal or biomass CHP.
    %td
    %td 24%
    %td
    %td
    %td
    %td 5%
    %td
    %td
    %td 63%
    %td 1%
    %td 7%
  %tr.trajectory.trajectory13
    %td District heating, powered by a mixture of coal CHP, biomass CHP, some gas CHP and power station heat
    %td 
    %td 19%
    %td
    %td
    %td
    %td 10%
    %td
    %td 24%
    %td 35%
    %td 1%
    %td 11%
  %tr.trajectory.trajectory14
    %td District heating, powered by a mixture of coal CHP, biomass CHP, gas CHP and power station heat
    %td
    %td 19% 
    %td
    %td
    %td
    %td 10%
    %td
    %td 30%
    %td 33%
    %td 1%
    %td 7%
  %tr.trajectory.trajectory21
    %td Gas or biogas powered fuel cell micro CHP in people's homes
    %td
    %td 10% 
    %td
    %td
    %td
    %td
    %td 90%
    %td
    %td
    %td
    %td
  %tr.trajectory.trajectory
    %td 
    %td
    %td 
    %td
    %td
    %td
    %td
    %td
    %td
    %td
    %td
    %td
  %tr.trajectory.trajectory
    %td 
    %td
    %td 
    %td
    %td
    %td
    %td
    %td
    %td
    %td
    %td
    %td
  %tr.trajectory.trajectory
    %td 
    %td
    %td 
    %td
    %td
    %td
    %td
    %td
    %td
    %td
    %td
    %td
  %tr.trajectory.trajectory
    %td 
    %td
    %td 
    %td
    %td
    %td
    %td
    %td
    %td
    %td
    %td
    %td
  %tr.trajectory.trajectory
    %td 
    %td
    %td 
    %td
    %td
    %td
    %td
    %td
    %td
    %td
    %td
    %td
